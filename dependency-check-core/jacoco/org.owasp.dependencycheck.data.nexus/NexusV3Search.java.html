<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>NexusV3Search.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Dependency-Check Core</a> &gt; <a href="index.source.html" class="el_package">org.owasp.dependencycheck.data.nexus</a> &gt; <span class="el_source">NexusV3Search.java</span></div><h1>NexusV3Search.java</h1><pre class="source lang-java linenums">/*
 * This file is part of dependency-check-core.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 * Copyright (c) 2023 Hans Aikema. All Rights Reserved.
 */
package org.owasp.dependencycheck.data.nexus;

import org.apache.hc.client5.http.HttpResponseException;
import org.apache.hc.client5.http.impl.classic.AbstractHttpClientResponseHandler;
import org.apache.hc.client5.http.impl.classic.CloseableHttpClient;
import org.apache.hc.core5.http.ContentType;
import org.apache.hc.core5.http.HttpEntity;
import org.apache.hc.core5.http.HttpHeaders;
import org.apache.hc.core5.http.message.BasicHeader;
import org.jetbrains.annotations.Nullable;
import org.owasp.dependencycheck.utils.DownloadFailedException;
import org.owasp.dependencycheck.utils.Downloader;
import org.owasp.dependencycheck.utils.ResourceNotFoundException;
import org.owasp.dependencycheck.utils.Settings;
import org.owasp.dependencycheck.utils.TooManyRequestsException;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import javax.annotation.concurrent.ThreadSafe;
import jakarta.json.Json;
import jakarta.json.JsonArray;
import jakarta.json.JsonObject;
import jakarta.json.JsonReader;
import java.io.BufferedReader;
import java.io.FileNotFoundException;
import java.io.IOException;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.io.StringReader;
import java.net.MalformedURLException;
import java.net.URL;
import java.nio.charset.StandardCharsets;
import java.util.ArrayList;
import java.util.HashSet;
import java.util.List;
import java.util.Set;
import java.util.stream.Collectors;

/**
 * Class of methods to search Nexus v3 repositories.
 *
 * @author Hans Aikema
 */
@ThreadSafe
public class NexusV3Search implements NexusSearch {

    /**
     * By default, NexusV3Search accepts only classifier-less artifacts.
     * &lt;p&gt;
     * This prevents, among others, sha1-collisions for empty jars on empty javadoc/sources jars.
     * See e.g. issues #5559 and #5118
     */
<span class="nc" id="L70">    private final Set&lt;String&gt; acceptedClassifiers = new HashSet&lt;&gt;();</span>

    /**
     * The root URL for the Nexus repository service.
     */
    private final URL rootURL;

    /**
     * Whether to use the Proxy when making requests.
     */
    private final boolean useProxy;
    /**
     * The configured settings.
     */
    private final Settings settings;
    /**
     * Used for logging.
     */
<span class="nc" id="L88">    private static final Logger LOGGER = LoggerFactory.getLogger(NexusV3Search.class);</span>

    /**
     * Creates a NexusV3Search for the given repository URL.
     *
     * @param settings the configured settings
     * @param useProxy flag indicating if the proxy settings should be used
     * @throws MalformedURLException thrown if the configured URL is
     *                               invalid
     */
<span class="nc" id="L98">    public NexusV3Search(Settings settings, boolean useProxy) throws MalformedURLException {</span>
<span class="nc" id="L99">        this.settings = settings;</span>
<span class="nc" id="L100">        this.useProxy = useProxy;</span>
<span class="nc" id="L101">        this.acceptedClassifiers.add(null);</span>
<span class="nc" id="L102">        final String searchUrl = settings.getString(Settings.KEYS.ANALYZER_NEXUS_URL);</span>
<span class="nc" id="L103">        LOGGER.debug(&quot;Nexus Search URL: {}&quot;, searchUrl);</span>
<span class="nc" id="L104">        this.rootURL = new URL(searchUrl);</span>

<span class="nc" id="L106">    }</span>

    @Override
    public MavenArtifact searchSha1(String sha1) throws IOException {
<span class="nc bnc" id="L110" title="All 4 branches missed.">        if (null == sha1 || !sha1.matches(&quot;^[0-9A-Fa-f]{40}$&quot;)) {</span>
<span class="nc" id="L111">            throw new IllegalArgumentException(&quot;Invalid SHA1 format&quot;);</span>
        }

<span class="nc" id="L114">        final List&lt;MavenArtifact&gt; collectedMatchingArtifacts = new ArrayList&lt;&gt;(1);</span>
<span class="nc" id="L115">        try (CloseableHttpClient client = Downloader.getInstance().getHttpClient(useProxy)) {</span>
<span class="nc" id="L116">            String continuationToken = retrievePageAndAddMatchingArtifact(client, collectedMatchingArtifacts, sha1, null);</span>
<span class="nc bnc" id="L117" title="All 4 branches missed.">            while (continuationToken != null &amp;&amp; collectedMatchingArtifacts.isEmpty()) {</span>
<span class="nc" id="L118">                continuationToken = retrievePageAndAddMatchingArtifact(client, collectedMatchingArtifacts, sha1, continuationToken);</span>
            }
        }
<span class="nc bnc" id="L121" title="All 2 branches missed.">        if (collectedMatchingArtifacts.isEmpty()) {</span>
<span class="nc" id="L122">            throw new FileNotFoundException(&quot;Artifact not found in Nexus&quot;);</span>
        } else {
<span class="nc" id="L124">            return collectedMatchingArtifacts.get(0);</span>
        }
    }

    private String retrievePageAndAddMatchingArtifact(CloseableHttpClient client, List&lt;MavenArtifact&gt; collectedMatchingArtifacts, String sha1,
                                                      @Nullable String continuationToken) throws IOException {
        final URL url;
<span class="nc" id="L131">        LOGGER.debug(&quot;Search with continuation token {}&quot;, continuationToken);</span>
<span class="nc bnc" id="L132" title="All 2 branches missed.">        if (continuationToken == null) {</span>
<span class="nc" id="L133">            url = new URL(rootURL, String.format(&quot;v1/search/?sha1=%s&quot;,</span>
<span class="nc" id="L134">                    sha1.toLowerCase()));</span>
        } else {
<span class="nc" id="L136">            url = new URL(rootURL, String.format(&quot;v1/search/?sha1=%s&amp;continuationToken=%s&quot;,</span>
<span class="nc" id="L137">                    sha1.toLowerCase(), continuationToken));</span>
        }

<span class="nc" id="L140">        LOGGER.debug(&quot;Searching Nexus url {}&quot;, url);</span>
        // Determine if we need to use a proxy. The rules:
        // 1) If the proxy is set, AND the setting is set to true, use the proxy
        // 2) Otherwise, don't use the proxy (either the proxy isn't configured,
        // or proxy is specifically set to false
<span class="nc" id="L145">        final NexusV3SearchResponseHandler handler = new NexusV3SearchResponseHandler(collectedMatchingArtifacts, sha1, acceptedClassifiers);</span>
        try {
<span class="nc" id="L147">            return Downloader.getInstance().fetchAndHandle(client, url, handler, List.of(new BasicHeader(HttpHeaders.ACCEPT,</span>
                            ContentType.APPLICATION_JSON)));
<span class="nc" id="L149">        } catch (TooManyRequestsException | ResourceNotFoundException | DownloadFailedException e) {</span>
<span class="nc bnc" id="L150" title="All 2 branches missed.">            if (LOGGER.isDebugEnabled()) {</span>
<span class="nc" id="L151">                int responseCode = -1;</span>
<span class="nc" id="L152">                String responseMessage = &quot;&quot;;</span>
<span class="nc bnc" id="L153" title="All 2 branches missed.">                if (e.getCause() instanceof HttpResponseException) {</span>
<span class="nc" id="L154">                    final HttpResponseException cause = (HttpResponseException) e.getCause();</span>
<span class="nc" id="L155">                    responseCode = cause.getStatusCode();</span>
<span class="nc" id="L156">                    responseMessage = cause.getReasonPhrase();</span>
                }
<span class="nc" id="L158">                LOGGER.debug(&quot;Could not connect to Nexus received response code: {} {}&quot;,</span>
<span class="nc" id="L159">                        responseCode, responseMessage);</span>
            }
<span class="nc" id="L161">            throw new IOException(&quot;Could not connect to Nexus&quot;, e);</span>
        }
    }

    private static final class NexusV3SearchResponseHandler extends AbstractHttpClientResponseHandler&lt;String&gt; {

        /**
         * The list to which matching artifacts are to be added
         */
        private final List&lt;MavenArtifact&gt; matchingArtifacts;
        /**
         * The sha1 for which the search results are being handled
         */
        private final String sha1;
        /**
         * The classifiers to be accepted
         */
        private final Set&lt;String&gt; acceptedClassifiers;

<span class="nc" id="L180">        private NexusV3SearchResponseHandler(List&lt;MavenArtifact&gt; matchingArtifacts, String sha1, Set&lt;String&gt; acceptedClassifiers) {</span>
<span class="nc" id="L181">            this.matchingArtifacts = matchingArtifacts;</span>
<span class="nc" id="L182">            this.sha1 = sha1;</span>
<span class="nc" id="L183">            this.acceptedClassifiers = acceptedClassifiers;</span>
<span class="nc" id="L184">        }</span>

        @Override
        public @Nullable String handleEntity(HttpEntity entity) throws IOException {
<span class="nc" id="L188">            try (InputStream in = entity.getContent();</span>
<span class="nc" id="L189">                 InputStreamReader isReader = new InputStreamReader(in, StandardCharsets.UTF_8);</span>
<span class="nc" id="L190">                 BufferedReader reader = new BufferedReader(isReader);</span>
            ) {
<span class="nc" id="L192">                final String jsonString = reader.lines().collect(Collectors.joining(&quot;\n&quot;));</span>
<span class="nc" id="L193">                LOGGER.debug(&quot;JSON String was &gt;&gt;&gt;{}&lt;&lt;&lt;&quot;, jsonString);</span>
                final JsonObject jsonResponse;
                try (
<span class="nc" id="L196">                        StringReader stringReader = new StringReader(jsonString);</span>
<span class="nc" id="L197">                        JsonReader jsonReader = Json.createReader(stringReader)</span>
                ) {
<span class="nc" id="L199">                    jsonResponse = jsonReader.readObject();</span>
                }
<span class="nc" id="L201">                LOGGER.debug(&quot;Response: {}&quot;, jsonResponse);</span>
<span class="nc" id="L202">                final JsonArray components = jsonResponse.getJsonArray(&quot;items&quot;);</span>
<span class="nc" id="L203">                LOGGER.debug(&quot;Items: {}&quot;, components);</span>
<span class="nc" id="L204">                final String continuationToken = jsonResponse.getString(&quot;continuationToken&quot;, null);</span>
<span class="nc" id="L205">                boolean found = false;</span>
<span class="nc bnc" id="L206" title="All 4 branches missed.">                for (int i = 0; i &lt; components.size() &amp;&amp; !found; i++) {</span>
<span class="nc" id="L207">                    boolean jarFound = false;</span>
<span class="nc" id="L208">                    boolean pomFound = false;</span>
<span class="nc" id="L209">                    String downloadUrl = null;</span>
<span class="nc" id="L210">                    String groupId = null;</span>
<span class="nc" id="L211">                    String artifactId = null;</span>
<span class="nc" id="L212">                    String version = null;</span>
<span class="nc" id="L213">                    String pomUrl = null;</span>

<span class="nc" id="L215">                    final JsonObject component = components.getJsonObject(i);</span>

<span class="nc" id="L217">                    final String format = component.getString(&quot;format&quot;, &quot;unknown&quot;);</span>
<span class="nc bnc" id="L218" title="All 2 branches missed.">                    if (&quot;maven2&quot;.equals(format)) {</span>
<span class="nc" id="L219">                        LOGGER.debug(&quot;Checking Maven2 artifact for {}&quot;, component);</span>
<span class="nc" id="L220">                        final JsonArray assets = component.getJsonArray(&quot;assets&quot;);</span>
<span class="nc bnc" id="L221" title="All 4 branches missed.">                        for (int j = 0; !found &amp;&amp; j &lt; assets.size(); j++) {</span>
<span class="nc" id="L222">                            final JsonObject asset = assets.getJsonObject(j);</span>
<span class="nc" id="L223">                            LOGGER.debug(&quot;Checking {}&quot;, asset);</span>
<span class="nc" id="L224">                            final JsonObject checksums = asset.getJsonObject(&quot;checksum&quot;);</span>
<span class="nc" id="L225">                            final JsonObject maven2 = asset.getJsonObject(&quot;maven2&quot;);</span>
<span class="nc bnc" id="L226" title="All 2 branches missed.">                            if (maven2 != null) {</span>
                                // logical names for the jar acceptance routine
<span class="nc bnc" id="L228" title="All 4 branches missed.">                                final boolean shaMatch = checksums != null &amp;&amp; sha1.equals(checksums.getString(&quot;sha1&quot;, null));</span>
<span class="nc" id="L229">                                final boolean hasAcceptedClassifier = acceptedClassifiers.contains(maven2.getString(&quot;classifier&quot;, null));</span>
<span class="nc" id="L230">                                final boolean isAJar = &quot;jar&quot;.equals(maven2.getString(&quot;extension&quot;, null));</span>
<span class="nc" id="L231">                                LOGGER.debug(&quot;shaMatch {}&quot;, shaMatch);</span>
<span class="nc" id="L232">                                LOGGER.debug(&quot;hasAcceptedClassifier {}&quot;, hasAcceptedClassifier);</span>
<span class="nc" id="L233">                                LOGGER.debug(&quot;isAJar {}&quot;, isAJar);</span>
<span class="nc bnc" id="L234" title="All 6 branches missed.">                                if (</span>
                                        isAJar
                                        &amp;&amp; hasAcceptedClassifier
                                        &amp;&amp; shaMatch
                                ) {
<span class="nc" id="L239">                                    downloadUrl = asset.getString(&quot;downloadUrl&quot;);</span>
<span class="nc" id="L240">                                    groupId = maven2.getString(&quot;groupId&quot;);</span>
<span class="nc" id="L241">                                    artifactId = maven2.getString(&quot;artifactId&quot;);</span>
<span class="nc" id="L242">                                    version = maven2.getString(&quot;version&quot;);</span>

<span class="nc" id="L244">                                    jarFound = true;</span>
<span class="nc bnc" id="L245" title="All 2 branches missed.">                                } else if (&quot;pom&quot;.equals(maven2.getString(&quot;extension&quot;))) {</span>
<span class="nc" id="L246">                                    LOGGER.debug(&quot;pom found {}&quot;, asset);</span>
<span class="nc" id="L247">                                    pomFound = true;</span>
<span class="nc" id="L248">                                    pomUrl = asset.getString(&quot;downloadUrl&quot;);</span>
                                }
                            }
<span class="nc bnc" id="L251" title="All 4 branches missed.">                            if (pomFound &amp;&amp; jarFound) {</span>
<span class="nc" id="L252">                                found = true;</span>
                            }
                        }
<span class="nc bnc" id="L255" title="All 2 branches missed.">                        if (found) {</span>
<span class="nc" id="L256">                            matchingArtifacts.add(new MavenArtifact(groupId, artifactId, version, downloadUrl, pomUrl));</span>
<span class="nc bnc" id="L257" title="All 2 branches missed.">                        } else if (jarFound) {</span>
<span class="nc" id="L258">                            final MavenArtifact ma = new MavenArtifact(groupId, artifactId, version, downloadUrl);</span>
<span class="nc" id="L259">                            ma.setPomUrl(MavenArtifact.derivePomUrl(artifactId, version, downloadUrl));</span>
<span class="nc" id="L260">                            matchingArtifacts.add(ma);</span>
<span class="nc" id="L261">                            found = true;</span>
                        }
                    }
                }
<span class="nc" id="L265">                return continuationToken;</span>
            }
        }
    }

    @Override
    public boolean preflightRequest() {
        try {
<span class="nc" id="L273">            final URL url = new URL(rootURL, &quot;v1/status&quot;);</span>
<span class="nc" id="L274">            final String response = Downloader.getInstance().fetchContent(url, useProxy, StandardCharsets.UTF_8);</span>
<span class="nc bnc" id="L275" title="All 4 branches missed.">            if (response == null || !response.isEmpty()) {</span>
<span class="nc bnc" id="L276" title="All 2 branches missed.">                LOGGER.warn(&quot;Expected empty OK response (content-length 0), got {}&quot;, response == null ? &quot;null&quot; : response.length());</span>
<span class="nc" id="L277">                return false;</span>
            }
<span class="nc" id="L279">        } catch (IOException | TooManyRequestsException | ResourceNotFoundException e) {</span>
<span class="nc" id="L280">            LOGGER.warn(&quot;Pre-flight request to Nexus failed: &quot;, e);</span>
<span class="nc" id="L281">            return false;</span>
<span class="nc" id="L282">        }</span>
<span class="nc" id="L283">        return true;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>