<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ArtifactorySearchResponseHandler.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Dependency-Check Core</a> &gt; <a href="index.source.html" class="el_package">org.owasp.dependencycheck.data.artifactory</a> &gt; <span class="el_source">ArtifactorySearchResponseHandler.java</span></div><h1>ArtifactorySearchResponseHandler.java</h1><pre class="source lang-java linenums">/*
 * This file is part of dependency-check-core.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 * Copyright (c) 2018 - 2024 Nicolas Henneaux; Hans Aikema. All Rights Reserved.
 */
package org.owasp.dependencycheck.data.artifactory;

import com.fasterxml.jackson.core.JsonParser;
import com.fasterxml.jackson.core.JsonToken;
import com.fasterxml.jackson.databind.DeserializationFeature;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.databind.ObjectReader;
import org.apache.hc.core5.http.ClassicHttpResponse;
import org.apache.hc.core5.http.io.HttpClientResponseHandler;
import org.owasp.dependencycheck.data.nexus.MavenArtifact;
import org.owasp.dependencycheck.dependency.Dependency;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.FileNotFoundException;
import java.io.IOException;
import java.io.InputStreamReader;
import java.nio.charset.StandardCharsets;
import java.util.ArrayList;
import java.util.List;
import java.util.Optional;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

class ArtifactorySearchResponseHandler implements HttpClientResponseHandler&lt;List&lt;MavenArtifact&gt;&gt; {
    /**
     * Pattern to match the path returned by the Artifactory AQL API.
     */
<span class="fc" id="L46">    private static final Pattern PATH_PATTERN = Pattern.compile(&quot;^/(?&lt;groupId&gt;.+)/(?&lt;artifactId&gt;[^/]+)/(?&lt;version&gt;[^/]+)/[^/]+$&quot;);</span>

    /**
     * Used for logging.
     */
<span class="fc" id="L51">    private static final Logger LOGGER = LoggerFactory.getLogger(ArtifactorySearchResponseHandler.class);</span>

    /**
     * Search result reader
     */
    private final ObjectReader fileImplReader;

    /**
     * The dependency that is expected to be in the response from Artifactory (if found)
     */
    private final Dependency expectedDependency;

    /**
     * Creates a responsehandler for the response on a single dependency-search attempt.
     *
     * @param dependency The dependency that is expected to be in the response when found (for validating the FileItem(s) in the response)
     */
<span class="fc" id="L68">    ArtifactorySearchResponseHandler(Dependency dependency) {</span>
<span class="fc" id="L69">        this.fileImplReader = new ObjectMapper().configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false).readerFor(FileImpl.class);</span>
<span class="fc" id="L70">        this.expectedDependency = dependency;</span>
<span class="fc" id="L71">    }</span>

    protected boolean init(JsonParser parser) throws IOException {
<span class="fc" id="L74">        com.fasterxml.jackson.core.JsonToken nextToken = parser.nextToken();</span>
<span class="pc bpc" id="L75" title="1 of 2 branches missed.">        if (nextToken != com.fasterxml.jackson.core.JsonToken.START_OBJECT) {</span>
<span class="nc" id="L76">            throw new IOException(&quot;Expected &quot; + com.fasterxml.jackson.core.JsonToken.START_OBJECT + &quot;, got &quot; + nextToken);</span>
        }

        do {
<span class="fc" id="L80">            nextToken = parser.nextToken();</span>
<span class="pc bpc" id="L81" title="1 of 2 branches missed.">            if (nextToken == null) {</span>
<span class="nc" id="L82">                break;</span>
            }

<span class="fc bfc" id="L85" title="All 2 branches covered.">            if (nextToken.isStructStart()) {</span>
<span class="pc bpc" id="L86" title="2 of 4 branches missed.">                if (nextToken == com.fasterxml.jackson.core.JsonToken.START_ARRAY &amp;&amp; &quot;results&quot;.equals(parser.currentName())) {</span>
<span class="fc" id="L87">                    return true;</span>
                } else {
<span class="nc" id="L89">                    parser.skipChildren();</span>
                }
            }
        } while (true);

<span class="nc" id="L94">        return false;</span>
    }

    /**
     * Validates the hashes of the dependency.
     *
     * @param checksums the collection of checksums (md5, sha1, [sha256])
     * @return Whether all available hashes match
     */
    private boolean checkHashes(ChecksumsImpl checksums) {
<span class="fc" id="L104">        final String md5sum = expectedDependency.getMd5sum();</span>
<span class="fc" id="L105">        final String hashMismatchFormat = &quot;Artifact found by API is not matching the {} of the artifact (repository hash is {} while actual is {}) !&quot;;</span>
<span class="fc" id="L106">        boolean match = true;</span>
<span class="fc bfc" id="L107" title="All 2 branches covered.">        if (!checksums.getMd5().equals(md5sum)) {</span>
<span class="fc" id="L108">            LOGGER.warn(hashMismatchFormat, &quot;md5&quot;, md5sum, checksums.getMd5());</span>
<span class="fc" id="L109">            match = false;</span>
        }
<span class="fc" id="L111">        final String sha1sum = expectedDependency.getSha1sum();</span>
<span class="fc bfc" id="L112" title="All 2 branches covered.">        if (!checksums.getSha1().equals(sha1sum)) {</span>
<span class="fc" id="L113">            LOGGER.warn(hashMismatchFormat, &quot;sha1&quot;, sha1sum, checksums.getSha1());</span>
<span class="fc" id="L114">            match = false;</span>
        }
<span class="fc" id="L116">        final String sha256sum = expectedDependency.getSha256sum();</span>
        /* For sha256 we need to validate that the checksum is non-null in the artifactory response.
         * Extract from Artifactory documentation:
         * New artifacts that are uploaded to Artifactory 5.5 and later will automatically have their SHA-256 checksum calculated.
         * However, artifacts that were already hosted in Artifactory before the upgrade will not have their SHA-256 checksum in the database yet.
         * To make full use of Artifactory's SHA-256 capabilities, you need to Migrate the Database to Include SHA-256 making sure that the record
         * for each artifact includes its SHA-256 checksum.
         */
<span class="fc bfc" id="L124" title="All 4 branches covered.">        if (checksums.getSha256() != null &amp;&amp; !checksums.getSha256().equals(sha256sum)) {</span>
<span class="fc" id="L125">            LOGGER.warn(hashMismatchFormat, &quot;sha256&quot;, sha256sum, checksums.getSha256());</span>
<span class="fc" id="L126">            match = false;</span>
        }
<span class="fc" id="L128">        return match;</span>
    }

    /**
     * Process the Artifactory response.
     *
     * @param response the HTTP response
     * @return a list of the Maven Artifact informations that match the searched dependency hash
     * @throws FileNotFoundException When a matching artifact is not found
     * @throws IOException           thrown if there is an I/O error
     */
    @Override
    public List&lt;MavenArtifact&gt; handleResponse(ClassicHttpResponse response) throws IOException {
<span class="fc" id="L141">        final List&lt;MavenArtifact&gt; result = new ArrayList&lt;&gt;();</span>

<span class="fc" id="L143">        try (InputStreamReader streamReader = new InputStreamReader(response.getEntity().getContent(), StandardCharsets.UTF_8);</span>
<span class="fc" id="L144">             JsonParser parser = fileImplReader.getFactory().createParser(streamReader)) {</span>

<span class="pc bpc" id="L146" title="1 of 4 branches missed.">            if (init(parser) &amp;&amp; parser.nextToken() == JsonToken.START_OBJECT) {</span>
                // at least one result
                do {
<span class="fc" id="L149">                    final FileImpl file = fileImplReader.readValue(parser);</span>

<span class="fc bfc" id="L151" title="All 2 branches covered.">                    if (file.getChecksums() == null) {</span>
<span class="fc" id="L152">                        LOGGER.warn(&quot;No checksums found in artifactory search result of uri {}. Please make sure that header X-Result-Detail is retained on any (reverse)-proxy, loadbalancer or WebApplicationFirewall in the network path to your Artifactory Server&quot;,</span>
<span class="fc" id="L153">                                file.getUri());</span>
<span class="fc" id="L154">                        continue;</span>
                    }

<span class="fc" id="L157">                    final Optional&lt;Matcher&gt; validationResult = validateUsability(file);</span>
<span class="fc bfc" id="L158" title="All 2 branches covered.">                    if (validationResult.isEmpty()) {</span>
<span class="fc" id="L159">                        continue;</span>
                    }
<span class="fc" id="L161">                    final Matcher pathMatcher = validationResult.get();</span>

<span class="fc" id="L163">                    final String groupId = pathMatcher.group(&quot;groupId&quot;).replace('/', '.');</span>
<span class="fc" id="L164">                    final String artifactId = pathMatcher.group(&quot;artifactId&quot;);</span>
<span class="fc" id="L165">                    final String version = pathMatcher.group(&quot;version&quot;);</span>

<span class="fc" id="L167">                    result.add(new MavenArtifact(groupId, artifactId, version, file.getDownloadUri(),</span>
<span class="fc" id="L168">                            MavenArtifact.derivePomUrl(artifactId, version, file.getDownloadUri())));</span>

<span class="fc bfc" id="L170" title="All 2 branches covered.">                } while (parser.nextToken() == JsonToken.START_OBJECT);</span>
            } else {
<span class="fc" id="L172">                throw new FileNotFoundException(&quot;Artifact &quot; + expectedDependency + &quot; not found in Artifactory&quot;);</span>
            }
        }
<span class="fc bfc" id="L175" title="All 2 branches covered.">        if (result.isEmpty()) {</span>
<span class="fc" id="L176">            throw new FileNotFoundException(&quot;Artifact &quot; + expectedDependency</span>
                    + &quot; not found in Artifactory; discovered sha1 hits not recognized as matching maven artifacts&quot;);
        }
<span class="fc" id="L179">        return result;</span>
    }

    /**
     * Validate the FileImpl result for usability as a dependency.
     * &lt;br/&gt;
     * Checks that the actually matches all known hashes and the path appears to match a maven repository G/A/V pattern.
     *
     * @param file The FileImpl from an Artifactory search response
     * @return An Optional with the Matcher for the file path to retrieve the Maven G/A/V coordinates in case result is usable for further
     * processing, otherwise an empty Optional.
     */
    private Optional&lt;Matcher&gt; validateUsability(FileImpl file) {
        final Optional&lt;Matcher&gt; result;
<span class="fc bfc" id="L193" title="All 2 branches covered.">        if (!checkHashes(file.getChecksums())) {</span>
<span class="fc" id="L194">            result = Optional.empty();</span>
        } else {
<span class="fc" id="L196">            final Matcher pathMatcher = PATH_PATTERN.matcher(file.getPath());</span>
<span class="fc bfc" id="L197" title="All 2 branches covered.">            if (!pathMatcher.matches()) {</span>
<span class="fc" id="L198">                LOGGER.debug(&quot;Cannot extract the Maven information from the path retrieved in Artifactory {}&quot;, file.getPath());</span>
<span class="fc" id="L199">                result = Optional.empty();</span>
            } else {
<span class="fc" id="L201">                result = Optional.of(pathMatcher);</span>
            }
        }
<span class="fc" id="L204">        return result;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>